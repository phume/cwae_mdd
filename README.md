# CWAE-MMD: Conditional Wasserstein Autoencoders for Contextual Anomaly Detection in Transaction Monitoring

This repository contains the code, data, and results for the paper:

> **CWAE-MMD: Conditional Wasserstein Autoencoders for Contextual Anomaly Detection in Transaction Monitoring**

## Folder Structure

```
CWAE_MDD_Publish/
├── paper/                  # LaTeX source and compiled PDF
│   ├── main.tex
│   ├── references.bib
│   └── main.pdf
│
├── code/                   # Source code to reproduce experiments
│   ├── src/
│   │   ├── models/
│   │   │   ├── cwae_mmd.py     # CWAE-MMD architecture (encoder, decoder, MMD)
│   │   │   ├── baselines.py    # CVAE, Isolation Forest, Deep Isolation Forest
│   │   │   └── variants.py     # All CWAE-MMD variant factories
│   │   ├── data/
│   │   │   └── synthetic.py    # Synthetic dataset generators
│   │   ├── evaluation/
│   │   │   └── metrics.py      # AUROC, AUPRC, P@K metrics
│   │   ├── training.py         # Training pipeline with early stopping
│   │   └── losses.py           # CRPS, Huber loss functions
│   ├── scripts/
│   │   ├── run_synthetic.py    # Reproduce Table 1 (synthetic datasets)
│   │   └── run_real.py         # Reproduce Table 2 (real-world datasets)
│   └── requirements.txt
│
├── data/
│   ├── odds/               # ODDS benchmark datasets (included, ~1 MB)
│   │   ├── thyroid.mat
│   │   ├── cardio.mat
│   │   ├── arrhythmia.mat
│   │   ├── ionosphere.mat
│   │   ├── pima.mat
│   │   ├── wbc.mat
│   │   └── vowels.mat
│   └── README.md           # Download instructions for large Kaggle datasets
│
├── results/                # Pre-computed experiment results
│   ├── synthetic_summary.csv   # Table 1: mean AUROC per method (4 datasets)
│   ├── synthetic_raw.csv       # Raw results: 204 runs (4 datasets x 17 models x 3 seeds)
│   ├── real_summary.csv        # Table 2: mean AUROC per method (11 datasets)
│   └── real_raw.csv            # Raw results: 330 runs (11 datasets x 10 models x 3 seeds)
│
├── references/             # Key reference papers (PDF)
│   ├── Wasserstein Auto-Encoders.pdf
│   ├── Anomaly Detection With Conditional Variational Autoencoders.pdf
│   ├── Deep Isolation Forest for Anomaly Detection.pdf
│   ├── Contextual Learning for Anomaly Detection in Tabular Data.pdf
│   └── Robust Contextual Outlier Detection_ Where Context Meets Sparsity.pdf
│
└── README.md               # This file
```

## Setup

```bash
cd code
pip install -r requirements.txt
```

Requires Python 3.9+ and PyTorch 2.0+.

## Reproducing Experiments

### Table 1: Synthetic Datasets

No data download needed -- synthetic datasets are generated by the code.

```bash
cd code
python scripts/run_synthetic.py
```

This runs 17 model variants across 4 synthetic contextual anomaly datasets (linear, scale, nonlinear, multimodal) with 3 seeds. Results are saved to `results/full_comparison_raw.csv`.

### Table 2: Real-World Datasets

1. **ODDS datasets** (7 datasets): Already included in `data/odds/`. The script searches for `.mat` files in `data/raw/` and the CDIF sibling project. To use the included files, copy them:
   ```bash
   mkdir -p data/raw
   cp ../data/odds/*.mat data/raw/
   ```

2. **Kaggle datasets** (4 datasets): Download per instructions in `data/README.md` and place in `data/raw/`.

3. Run:
   ```bash
   cd code
   python scripts/run_real.py
   ```

This runs 10 methods across all available datasets with 3 seeds. The script has checkpoint/resume support -- if interrupted, re-run the same command to continue.

## Methods Evaluated

### CWAE-MMD Variants (ours)
| Variant | Scoring | Loss | Description |
|---------|---------|------|-------------|
| CWAE-IF | IF on residuals | MSE | Base variant |
| CWAE-DIF | DIF on residuals | MSE | Non-linear projections before IF |
| CWAE-IF-Latent | IF on latent codes | MSE | Scores in learned representation |
| CWAE-IF-Dual | IF on residuals + latent | MSE | Max of both scoring spaces |
| CWAE-DIF-Dual | DIF on residuals + latent | MSE | Most expressive variant |
| CWAE-CRPS | IF on residuals | CRPS | Robust loss, best default |
| CWAE-Huber | IF on residuals | Huber | Smooth L1/L2 hybrid loss |

### Baselines
| Method | Description |
|--------|-------------|
| IF | Isolation Forest on behavioral features only |
| IF-concat | Isolation Forest on concatenated [behavior; context] |
| DIF | Deep Isolation Forest with random MLP projections |
| CVAE | Conditional VAE with KL divergence regularization |

## Key Results

- **Contextual anomalies** (Linear, Nonlinear): CWAE-MMD achieves 0.988--1.000 AUROC vs IF 0.833
- **Financial fraud** (PaySim): CWAE-IF achieves 0.913 AUROC vs IF 0.789 (+16%)
- **Numerical stability**: Zero NaN training runs across all experiments (vs CVAE instability on skewed data)
- **Recommended default**: CWAE-CRPS -- robust loss handles heavy-tailed financial data

## Pre-computed Results

All experiment results are available in `results/` as CSV files. To load:

```python
import pandas as pd

# Synthetic results (Table 1)
syn = pd.read_csv("results/synthetic_summary.csv")
print(syn.pivot_table(values="auroc_mean", index="model", columns="dataset"))

# Real-world results (Table 2)
real = pd.read_csv("results/real_summary.csv")
print(real.pivot_table(values="auroc_mean", index="method", columns="dataset"))
```

## Citation

If you use this code in your research, please cite:

```bibtex
@article{cwae-mmd-2025,
  title={CWAE-MMD: Conditional Wasserstein Autoencoders for Contextual Anomaly Detection in Transaction Monitoring},
  author={Anonymous},
  year={2025}
}
```
